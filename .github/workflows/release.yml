name: Release Binaries

on:
  push:
    tags:
      - 'v*'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  # Run tests before building
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Haskell (Stack)
        uses: haskell-actions/setup@v2
        with:
          enable-stack: true
          stack-version: 'latest'
          cabal-update: false

      - name: Cache Stack
        uses: actions/cache@v4
        with:
          path: |
            ~/.stack
            .stack-work
          key: ${{ runner.os }}-stack-${{ hashFiles('stack.yaml', 'stack.yaml.lock', '**/*.cabal') }}
          restore-keys: |
            ${{ runner.os }}-stack-

      - name: Install Z3 SMT solver
        run: |
          sudo apt-get update
          sudo apt-get install -y z3

      - name: Build all packages
        run: stack build --test --no-run-tests

      - name: Run tests for tcg-platform-cert
        run: stack test tcg-platform-cert

      - name: Run tests for tcg-platform-cert-compliance
        run: stack test tcg-platform-cert-compliance

      - name: Run tests for tcg-platform-cert-validation
        run: stack test tcg-platform-cert-validation

      - name: Run tests for tcg-platform-cert-util
        run: stack test tcg-platform-cert-util

      - name: Run tests for platform-hardware-info
        run: stack test platform-hardware-info

  # Linux static builds using Podman + Alpine musl
  build-linux:
    needs: test
    name: Linux ${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        arch: [x86_64, aarch64]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi

      - name: Build static binary
        run: |
          chmod +x ./scripts/build-static.sh
          ./scripts/build-static.sh ${{ matrix.arch }} ${{ steps.version.outputs.version }}

      - name: Verify binary
        run: |
          file dist/tcg-platform-cert-util-*
          ls -lh dist/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-${{ matrix.arch }}
          path: dist/tcg-platform-cert-util-*
          retention-days: 7

  # macOS builds for Intel and Apple Silicon
  build-macos:
    needs: test
    name: macOS ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-15-intel  # Intel (x86_64)
            arch: x86_64
          - os: macos-14        # Apple Silicon (arm64)
            arch: arm64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Haskell (Stack)
        uses: haskell-actions/setup@v2
        with:
          enable-stack: true
          stack-version: 'latest'
          cabal-update: false

      - name: Cache Stack
        uses: actions/cache@v4
        with:
          path: |
            ~/.stack
            .stack-work
          key: ${{ runner.os }}-${{ matrix.arch }}-stack-${{ hashFiles('stack.yaml', 'stack.yaml.lock', '**/*.cabal') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.arch }}-stack-

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi

      - name: Build
        run: stack build tcg-platform-cert-util

      - name: Copy binary
        run: |
          mkdir -p dist
          BINARY=$(stack exec -- which tcg-platform-cert-util)
          cp "$BINARY" "dist/tcg-platform-cert-util-${{ steps.version.outputs.version }}-macos-${{ matrix.arch }}"
          chmod +x "dist/tcg-platform-cert-util-${{ steps.version.outputs.version }}-macos-${{ matrix.arch }}"

      - name: Verify binary
        run: |
          file dist/tcg-platform-cert-util-*
          otool -L dist/tcg-platform-cert-util-*
          ls -lh dist/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.arch }}
          path: dist/tcg-platform-cert-util-*
          retention-days: 7

  # Windows build
  build-windows:
    needs: test
    name: Windows x86_64
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Haskell (Stack)
        uses: haskell-actions/setup@v2
        with:
          enable-stack: true
          stack-version: 'latest'
          cabal-update: false

      - name: Cache Stack
        uses: actions/cache@v4
        with:
          path: |
            ~\AppData\Roaming\stack
            ~\AppData\Local\Programs\stack
            .stack-work
          key: ${{ runner.os }}-stack-${{ hashFiles('stack.yaml', 'stack.yaml.lock', '**/*.cabal') }}
          restore-keys: |
            ${{ runner.os }}-stack-

      - name: Determine version
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi

      - name: Build
        run: stack build tcg-platform-cert-util

      - name: Copy binary
        shell: bash
        run: |
          mkdir -p dist
          BINARY=$(stack exec -- which tcg-platform-cert-util)
          cp "$BINARY" "dist/tcg-platform-cert-util-${{ steps.version.outputs.version }}-windows-x86_64.exe"

      - name: Verify binary
        shell: bash
        run: |
          file dist/tcg-platform-cert-util-*.exe
          ls -lh dist/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-x86_64
          path: dist/tcg-platform-cert-util-*.exe
          retention-days: 7

  # Create macOS Universal Binary
  build-macos-universal:
    name: macOS Universal
    needs: build-macos
    runs-on: macos-14

    steps:
      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: macos-*
          path: binaries

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi

      - name: Create Universal Binary
        run: |
          mkdir -p dist
          VERSION="${{ steps.version.outputs.version }}"

          # Find the binaries
          X86_BINARY=$(find binaries -name "*-macos-x86_64" | head -1)
          ARM_BINARY=$(find binaries -name "*-macos-arm64" | head -1)

          echo "x86_64 binary: $X86_BINARY"
          echo "arm64 binary: $ARM_BINARY"

          # Create Universal Binary
          lipo -create "$X86_BINARY" "$ARM_BINARY" \
            -output "dist/tcg-platform-cert-util-${VERSION}-macos-universal"

          chmod +x "dist/tcg-platform-cert-util-${VERSION}-macos-universal"

      - name: Verify Universal Binary
        run: |
          file dist/tcg-platform-cert-util-*
          lipo -info dist/tcg-platform-cert-util-*
          ls -lh dist/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-universal
          path: dist/tcg-platform-cert-util-*
          retention-days: 7

  # Create GitHub Release with all binaries
  release:
    name: Create Release
    needs: [build-linux, build-macos-universal, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: |
          find artifacts -type f -ls

      - name: Prepare release files
        run: |
          mkdir -p release
          find artifacts -type f -name "tcg-platform-cert-util-*" -exec cp {} release/ \;
          ls -lh release/

      - name: Create checksums
        run: |
          cd release
          sha256sum tcg-platform-cert-util-* > checksums-sha256.txt
          cat checksums-sha256.txt

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          generate_release_notes: true
          files: |
            release/tcg-platform-cert-util-*
            release/checksums-sha256.txt
          body: |
            ## Downloads

            | Platform | Architecture | File |
            |----------|--------------|------|
            | Linux | x86_64 | `tcg-platform-cert-util-${{ steps.version.outputs.version }}-linux-x86_64` |
            | Linux | aarch64 | `tcg-platform-cert-util-${{ steps.version.outputs.version }}-linux-aarch64` |
            | macOS | Universal | `tcg-platform-cert-util-${{ steps.version.outputs.version }}-macos-universal` |
            | macOS | Intel | `tcg-platform-cert-util-${{ steps.version.outputs.version }}-macos-x86_64` |
            | macOS | Apple Silicon | `tcg-platform-cert-util-${{ steps.version.outputs.version }}-macos-arm64` |
            | Windows | x86_64 | `tcg-platform-cert-util-${{ steps.version.outputs.version }}-windows-x86_64.exe` |

            ### Linux binaries
            Statically linked with musl libc. Works on any Linux distribution.

            ### macOS binaries
            - **Universal**: Works on both Intel and Apple Silicon Macs
            - Architecture-specific binaries also available

            ### Windows binaries
            Statically linked executable. No additional DLLs required.

            ### Verification
            ```bash
            sha256sum -c checksums-sha256.txt
            ```